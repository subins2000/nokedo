(function(e){e.fn.extend({autocomplete:function(t,n){var i=typeof t=='string';n=e.extend({},e.Autocompleter.defaults,{url:i?t:null,data:i?null:t,delay:i?e.Autocompleter.defaults.delay:10,max:n&&!n.scroll?10:150},n);n.highlight=n.highlight||function(e){return e};n.formatMatch=n.formatMatch||n.formatItem;return this.each(function(){new e.Autocompleter(this,n)})},result:function(e){return this.bind('result',e)},search:function(e){return this.trigger('search',[e])},flushCache:function(){return this.trigger('flushCache')},setOptions:function(e){return this.trigger('setOptions',[e])},unautocomplete:function(){return this.trigger('unautocomplete')}});e.Autocompleter=function(n,t){function C(){var o=i.selected();if(!o)return!1;var r=o.result;s=r;if(t.multiple){var u=l(a.val());if(u.length>1){var m=t.multipleSeparator.length,d=e(n).selection().start,f,c=0;e.each(u,function(e,t){c+=t.length;if(d<=c){f=e;return!1};c+=m});u[f]=r;r=u.join(t.multipleSeparator)};r+=t.multipleSeparator};a.val(r);h();a.trigger('result',[o.data,o.value]);return!0};function o(e,n){if(m==r.DEL){i.hide();return};var l=a.val();if(!n&&l==s)return;s=l;l=d(l);if(l.length>=t.minChars){a.addClass(t.loadingClass);if(!t.matchCase)l=l.toLowerCase();b(l,E,h)}else{p();i.hide()}};function l(n){if(!n)return[''];if(!t.multiple)return[e.trim(n)];return e.map(n.split(t.multipleSeparator),function(t){return e.trim(n).length?e.trim(t):null})};function d(i){if(!t.multiple)return i;var a=l(i);if(a.length==1)return a[0];var r=e(n).selection().start;if(r==i.length){a=l(i)}else{a=l(i.replace(i.substring(r),''))};return a[a.length-1]};function A(i,l){if(t.autoFill&&d(a.val()).toLowerCase()==i.toLowerCase()&&m!=r.BACKSPACE){a.val(a.val()+l.substring(d(s).length));e(n).selection(s.length,s.length+l.length)}};function T(){clearTimeout(c);c=setTimeout(h,200)};function h(){var e=i.visible();i.hide();clearTimeout(c);p();if(t.mustMatch){a.search(function(e){if(!e){if(t.multiple){var n=l(a.val()).slice(0,-1);a.val(n.join(t.multipleSeparator)+(n.length?t.multipleSeparator:''))}else{a.val('');a.trigger('result',null)}}})}};function E(e,t){if(t&&t.length&&u){p();i.display(t,e);A(e,t[0].value);i.show()}else{h()}};function b(a,r,o){if(!t.matchCase)a=a.toLowerCase();var l=f.load(a);if(l&&l.length){r(a,l)}else if(typeof t.url=='string'&&t.url.length>0){var s={timestamp:+(new Date)};e.each(t.extraParams,function(e,t){s[e]=typeof t=='function'?t():t});e.ajax({mode:'abort',port:'autocomplete'+n.name,dataType:t.dataType,url:t.url,data:e.extend({q:d(a),limit:t.max},s),success:function(e){var n=t.parse&&t.parse(e)||w(e);f.add(a,n);r(a,n)}})}else{i.emptyList();o(a)}};function w(n){var a=[],l=n.split('\n');for(var r=0;r<l.length;r++){var i=e.trim(l[r]);if(i){i=i.split('|');a[a.length]={data:i,value:i[0],result:t.formatResult&&t.formatResult(i,i[0])||i[0]}}};return a};function p(){a.removeClass(t.loadingClass)};var r={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8};var a=e(n).attr('autocomplete','off').addClass(t.inputClass),c,s='',f=e.Autocompleter.Cache(t),u=0,m,v={mouseDownOnSelect:!1};var i=e.Autocompleter.Select(t,n,C,v),g;e.browser.opera&&e(n.form).bind('submit.autocomplete',function(){if(g){g=!1;return!1}});a.bind((e.browser.opera?'keypress':'keydown')+'.autocomplete',function(n){u=1;m=n.keyCode;switch(n.keyCode){case r.UP:n.preventDefault();if(i.visible()){i.prev()}else{o(0,!0)};break;case r.DOWN:n.preventDefault();if(i.visible()){i.next()}else{o(0,!0)};break;case r.PAGEUP:n.preventDefault();if(i.visible()){i.pageUp()}else{o(0,!0)};break;case r.PAGEDOWN:n.preventDefault();if(i.visible()){i.pageDown()}else{o(0,!0)};break;case t.multiple&&e.trim(t.multipleSeparator)==','&&r.COMMA:case r.TAB:case r.RETURN:if(C()){n.preventDefault();g=!0;return!1};break;case r.ESC:i.hide();break;default:clearTimeout(c);c=setTimeout(o,t.delay);break}}).focus(function(){u++}).blur(function(){u=0;if(!v.mouseDownOnSelect){T()}}).click(function(){if(u++>1&&!i.visible()){o(0,!0)}}).bind('search',function(){function t(e,t){var i;if(t&&t.length){for(var r=0;r<t.length;r++){if(t[r].result.toLowerCase()==e.toLowerCase()){i=t[r];break}}};if(typeof n=='function')n(i);else a.trigger('result',i&&[i.data,i.value])};var n=arguments.length>1?arguments[1]:null;e.each(l(a.val()),function(e,n){b(n,t,t)})}).bind('flushCache',function(){f.flush()}).bind('setOptions',function(){e.extend(t,arguments[1]);if('data'in arguments[1])f.populate()}).bind('unautocomplete',function(){i.unbind();a.unbind();e(n.form).unbind('.autocomplete')})};e.Autocompleter.defaults={inputClass:'ac_input',resultsClass:'ac_results',loadingClass:'ac_loading',minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(e){return e[0]},formatMatch:null,autoFill:!1,width:0,multiple:!1,multipleSeparator:', ',highlight:function(e,t){return e.replace(new RegExp('(?![^&;]+;)(?!<[^<>]*)('+t.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,'\\$1')+')(?![^<>]*>)(?![^&;]+;)','gi'),'<strong>$1</strong>')},scroll:!0,scrollHeight:180};e.Autocompleter.Cache=function(t){function l(e,n){if(!t.matchCase)e=e.toLowerCase();var i=e.indexOf(n);if(t.matchContains=='word'){i=e.toLowerCase().search('\\b'+n.toLowerCase())};if(i==-1)return!1;return i==0||t.matchContains};function o(e,r){if(i>t.cacheLength){a()};if(!n[e]){i++};n[e]=r};function r(){if(!t.data)return!1;var i={},u=0;if(!t.url)t.cacheLength=1;i['']=[];for(var a=0,c=t.data.length;a<c;a++){var n=t.data[a];n=typeof n=='string'?[n]:n;var r=t.formatMatch(n,a+1,t.data.length);if(r===!1)continue;var l=r.charAt(0).toLowerCase();if(!i[l])i[l]=[];var s={value:r,data:n,result:t.formatResult&&t.formatResult(n)||r};i[l].push(s);if(u++<t.max){i[''].push(s)}};e.each(i,function(e,n){t.cacheLength++;o(e,n)})};function a(){n={};i=0};var n={};var i=0;setTimeout(r,25);return{flush:a,add:o,populate:r,load:function(a){if(!t.cacheLength||!i)return null;if(!t.url&&t.matchContains){var r=[];for(var u in n){if(u.length>0){var o=n[u];e.each(o,function(e,t){if(l(t.value,a)){r.push(t)}})}};return r}else if(n[a]){return n[a]}else if(t.matchSubset){for(var s=a.length-1;s>=t.minChars;s--){var o=n[a.substr(0,s)];if(o){var r=[];e.each(o,function(e,t){if(l(t.value,a)){r[r.length]=t}});return r}}};return null}}};e.Autocompleter.Select=function(t,n,m,d){function C(){if(!h)return;l=e('<div/>').hide().addClass(t.resultsClass).css('position','absolute').appendTo(document.body);r=e('<ul/>').appendTo(l).mouseover(function(t){if(c(t).nodeName&&c(t).nodeName.toUpperCase()=='LI'){a=e('li',r).removeClass(o.ACTIVE).index(c(t));e(c(t)).addClass(o.ACTIVE)}}).click(function(t){e(c(t)).addClass(o.ACTIVE);m();n.focus();return!1}).mousedown(function(){d.mouseDownOnSelect=!0}).mouseup(function(){d.mouseDownOnSelect=!1});if(t.width>0)l.css('width',t.width);h=!1};function c(e){var t=e.target;while(t&&t.tagName!='LI')t=t.parentNode;if(!t)return[];return t};function s(e){i.slice(a,a+1).removeClass(o.ACTIVE);v(e);var l=i.slice(a,a+1).addClass(o.ACTIVE);if(t.scroll){var n=0;i.slice(0,a).each(function(){n+=this.offsetHeight});if(n+l[0].offsetHeight-r.scrollTop()>r[0].clientHeight){r.scrollTop(n+l[0].offsetHeight-r.innerHeight())}else if(n<r.scrollTop()){r.scrollTop(n)}}};function v(e){a+=e;if(a<0){a=i.size()-1}else if(a>=i.size()){a=0}};function g(e){return t.max&&t.max<e?t.max:e};function p(){r.empty();var l=g(u.length);for(var n=0;n<l;n++){if(!u[n])continue;var s=t.formatItem(u[n].data,n+1,l,u[n].value,f);if(s===!1)continue;var c=e('<li/>').html(t.highlight(s,f)).addClass(n%2==0?'ac_even':'ac_odd').appendTo(r)[0];e.data(c,'ac_data',u[n])};i=r.find('li');if(t.selectFirst){i.slice(0,1).addClass(o.ACTIVE);a=0};if(e.fn.bgiframe)r.bgiframe()};var o={ACTIVE:'ac_over'};var i,a=-1,u,f='',h=!0,l,r;return{display:function(e,t){C();u=e;f=t;p()},next:function(){s(1)},prev:function(){s(-1)},pageUp:function(){if(a!=0&&a-8<0){s(-a)}else{s(-8)}},pageDown:function(){if(a!=i.size()-1&&a+8>i.size()){s(i.size()-1-a)}else{s(8)}},hide:function(){l&&l.hide();i&&i.removeClass(o.ACTIVE);a=-1},visible:function(){return l&&l.is(':visible')},current:function(){return this.visible()&&(i.filter('.'+o.ACTIVE)[0]||t.selectFirst&&i[0])},show:function(){var o=e(n).offset();l.css({width:typeof t.width=='string'||t.width>0?t.width:e(n).width(),top:o.top+n.offsetHeight,left:o.left}).show();if(t.scroll){r.scrollTop(0);r.css({maxHeight:t.scrollHeight,overflow:'auto'});if(e.browser.msie&&typeof document.body.style.maxHeight==='undefined'){var a=0;i.each(function(){a+=this.offsetHeight});var s=a>t.scrollHeight;r.css('height',s?t.scrollHeight:a);if(!s){i.width(r.width()-parseInt(i.css('padding-left'))-parseInt(i.css('padding-right')))}}}},selected:function(){var t=i&&i.filter('.'+o.ACTIVE).removeClass(o.ACTIVE);return t&&t.length&&e.data(t[0],'ac_data')},emptyList:function(){r&&r.empty()},unbind:function(){l&&l.remove()}}};e.fn.selection=function(e,t){if(e!==undefined){return this.each(function(){if(this.createTextRange){var n=this.createTextRange();if(t===undefined||e==t){n.move('character',e);n.select()}else{n.collapse(!0);n.moveStart('character',e);n.moveEnd('character',t);n.select()}}else if(this.setSelectionRange){this.setSelectionRange(e,t)}else if(this.selectionStart){this.selectionStart=e;this.selectionEnd=t}})};var n=this[0];if(n.createTextRange){var r=document.selection.createRange(),o=n.value,l='<->',a=r.text.length;r.text=l;var i=n.value.indexOf(l);n.value=o;this.selection(i,i+a);return{start:i,end:i+a}}else if(n.selectionStart!==undefined){return{start:n.selectionStart,end:n.selectionEnd}}}})(jQuery);